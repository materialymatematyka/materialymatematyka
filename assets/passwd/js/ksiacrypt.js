// variables to be filled when generating the file
    var encryptedMsg = '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',
        salt = '3a12bd0ba37ed9d0cf3308619c6fe0f4',
        isRememberEnabled = true,
        rememberDurationInDays = 30; // 0 means forever

    // constants
    var rememberPassphraseKey = 'staticrypt_passphrase',
        rememberExpirationKey = 'staticrypt_expiration';

    /**
     * Decrypt a salted msg using a password.
     * Inspired by https://github.com/adonespitogo
     *
     * @param  encryptedMsg
     * @param  hashedPassphrase
     * @returns 
     */
    function decryptMsg(encryptedMsg, hashedPassphrase) {
        var iv = CryptoJS.enc.Hex.parse(encryptedMsg.substr(0, 32))
        var encrypted = encryptedMsg.substring(32);

        return CryptoJS.AES.decrypt(encrypted, hashedPassphrase, {
            iv: iv,
            padding: CryptoJS.pad.Pkcs7,
            mode: CryptoJS.mode.CBC
        }).toString(CryptoJS.enc.Utf8);
    }

    /**
     * Decrypt our encrypted page, replace the whole HTML.
     *
     * @param  hashedPassphrase
     * @returns 
     */
    function decryptAndReplaceHtml(hashedPassphrase) {
        var encryptedHMAC = encryptedMsg.substring(0, 64),
            encryptedHTML = encryptedMsg.substring(64),
            decryptedHMAC = CryptoJS.HmacSHA256(encryptedHTML, CryptoJS.SHA256(hashedPassphrase).toString()).toString();

        if (decryptedHMAC !== encryptedHMAC) {
            return false;
        }

        var plainHTML = decryptMsg(encryptedHTML, hashedPassphrase);

        document.write(plainHTML);
        document.close();

        return true;
    }

    /**
     * Salt and hash the passphrase so it can be stored in localStorage without opening a password reuse vulnerability.
     *
     * @param  passphrase
     * @returns 
     */
    function hashPassphrase(passphrase) {
        return CryptoJS.PBKDF2(passphrase, salt, {
            keySize: 256 / 32,
            iterations: 1000
        }).toString();
    }

    /**
     * Clear localstorage from staticrypt related values
     */
    function clearLocalStorage() {
        localStorage.removeItem(rememberPassphraseKey);
        localStorage.removeItem(rememberExpirationKey);
    }

    // try to automatically decrypt on load if there is a saved password
    window.onload = function () {
        if (isRememberEnabled) {
            // show the remember me checkbox
            document.getElementById('staticrypt-remember-label').classList.remove('hidden');

            // if we are login out, clear the storage and terminate
            var queryParams = new URLSearchParams(window.location.search);

            if (queryParams.has("staticrypt_logout")) {
                return clearLocalStorage();
            }

            // if there is expiration configured, check if we're not beyond the expiration
            if (rememberDurationInDays && rememberDurationInDays > 0) {
                var expiration = localStorage.getItem(rememberExpirationKey),
                    isExpired = expiration && new Date().getTime() > parseInt(expiration);

                if (isExpired) {
                    return clearLocalStorage();
                }
            }

            var hashedPassphrase = localStorage.getItem(rememberPassphraseKey);

            if (hashedPassphrase) {
                // try to decrypt
                var isDecryptionSuccessful = decryptAndReplaceHtml(hashedPassphrase);

                // if the decryption is unsuccessful the password might be wrong - silently clear the saved data and let
                // the user fill the password form again
                if (!isDecryptionSuccessful) {
                    return clearLocalStorage();
                }
            }
        }
    }

    // handle password form submission
    document.getElementById('staticrypt-form').addEventListener('submit', function (e) {
        e.preventDefault();

        var passphrase = document.getElementById('staticrypt-password').value,
            shouldRememberPassphrase = document.getElementById('staticrypt-remember').checked;

        // decrypt and replace the whole page
        var hashedPassphrase = hashPassphrase(passphrase);
        var isDecryptionSuccessful = decryptAndReplaceHtml(hashedPassphrase);

        if (isDecryptionSuccessful) {
            // remember the hashedPassphrase and set its expiration if necessary
            if (isRememberEnabled && shouldRememberPassphrase) {
                window.localStorage.setItem(rememberPassphraseKey, hashedPassphrase);

                // set the expiration if the duration isn't 0 (meaning no expiration)
                if (rememberDurationInDays > 0) {
                    window.localStorage.setItem(
                        rememberExpirationKey,
                        (new Date().getTime() + rememberDurationInDays * 24 * 60 * 60 * 1000).toString()
                    );
                }
            }
        } else {
            alert('Hasło niepoprawne!');
        }
    });