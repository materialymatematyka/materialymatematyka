// variables to be filled when generating the file
    var encryptedMsg = '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',
        salt = '3a12bd0ba37ed9d0cf3308619c6fe0f4',
        isRememberEnabled = true,
        rememberDurationInDays = 30; // 0 means forever

    // constants
    var rememberPassphraseKey = 'staticrypt_passphrase',
        rememberExpirationKey = 'staticrypt_expiration';

    /**
     * Decrypt a salted msg using a password.
     * Inspired by https://github.com/adonespitogo
     *
     * @param  encryptedMsg
     * @param  hashedPassphrase
     * @returns 
     */
    function decryptMsg(encryptedMsg, hashedPassphrase) {
        var iv = CryptoJS.enc.Hex.parse(encryptedMsg.substr(0, 32))
        var encrypted = encryptedMsg.substring(32);

        return CryptoJS.AES.decrypt(encrypted, hashedPassphrase, {
            iv: iv,
            padding: CryptoJS.pad.Pkcs7,
            mode: CryptoJS.mode.CBC
        }).toString(CryptoJS.enc.Utf8);
    }

    /**
     * Decrypt our encrypted page, replace the whole HTML.
     *
     * @param  hashedPassphrase
     * @returns 
     */
    function decryptAndReplaceHtml(hashedPassphrase) {
        var encryptedHMAC = encryptedMsg.substring(0, 64),
            encryptedHTML = encryptedMsg.substring(64),
            decryptedHMAC = CryptoJS.HmacSHA256(encryptedHTML, CryptoJS.SHA256(hashedPassphrase).toString()).toString();

        if (decryptedHMAC !== encryptedHMAC) {
            return false;
        }

        var plainHTML = decryptMsg(encryptedHTML, hashedPassphrase);

        document.write(plainHTML);
        document.close();

        return true;
    }

    /**
     * Salt and hash the passphrase so it can be stored in localStorage without opening a password reuse vulnerability.
     *
     * @param  passphrase
     * @returns 
     */
    function hashPassphrase(passphrase) {
        return CryptoJS.PBKDF2(passphrase, salt, {
            keySize: 256 / 32,
            iterations: 1000
        }).toString();
    }

    /**
     * Clear localstorage from staticrypt related values
     */
    function clearLocalStorage() {
        localStorage.removeItem(rememberPassphraseKey);
        localStorage.removeItem(rememberExpirationKey);
    }

    // try to automatically decrypt on load if there is a saved password
    window.onload = function () {
        if (isRememberEnabled) {
            // show the remember me checkbox
            document.getElementById('staticrypt-remember-label').classList.remove('hidden');

            // if we are login out, clear the storage and terminate
            var queryParams = new URLSearchParams(window.location.search);

            if (queryParams.has("staticrypt_logout")) {
                return clearLocalStorage();
            }

            // if there is expiration configured, check if we're not beyond the expiration
            if (rememberDurationInDays && rememberDurationInDays > 0) {
                var expiration = localStorage.getItem(rememberExpirationKey),
                    isExpired = expiration && new Date().getTime() > parseInt(expiration);

                if (isExpired) {
                    return clearLocalStorage();
                }
            }

            var hashedPassphrase = localStorage.getItem(rememberPassphraseKey);

            if (hashedPassphrase) {
                // try to decrypt
                var isDecryptionSuccessful = decryptAndReplaceHtml(hashedPassphrase);

                // if the decryption is unsuccessful the password might be wrong - silently clear the saved data and let
                // the user fill the password form again
                if (!isDecryptionSuccessful) {
                    return clearLocalStorage();
                }
            }
        }
    }

    // handle password form submission
    document.getElementById('staticrypt-form').addEventListener('submit', function (e) {
        e.preventDefault();

        var passphrase = document.getElementById('staticrypt-password').value,
            shouldRememberPassphrase = document.getElementById('staticrypt-remember').checked;

        // decrypt and replace the whole page
        var hashedPassphrase = hashPassphrase(passphrase);
        var isDecryptionSuccessful = decryptAndReplaceHtml(hashedPassphrase);

        if (isDecryptionSuccessful) {
            // remember the hashedPassphrase and set its expiration if necessary
            if (isRememberEnabled && shouldRememberPassphrase) {
                window.localStorage.setItem(rememberPassphraseKey, hashedPassphrase);

                // set the expiration if the duration isn't 0 (meaning no expiration)
                if (rememberDurationInDays > 0) {
                    window.localStorage.setItem(
                        rememberExpirationKey,
                        (new Date().getTime() + rememberDurationInDays * 24 * 60 * 60 * 1000).toString()
                    );
                }
            }
        } else {
            alert('Hasło niepoprawne!');
        }
    });